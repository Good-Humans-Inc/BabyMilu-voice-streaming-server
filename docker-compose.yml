name: current

services:
  mqtt:
    image: eclipse-mosquitto:2.0
    networks:
      default: null
    ports:
      - "1883:1883"
    restart: unless-stopped
    volumes:
      - type: bind
        source: /srv/dev/current/mosquitto.conf
        target: /mosquitto/config/mosquitto.conf
        read_only: true
        bind:
          create_host_path: true

  server:
    build:
      context: /srv/dev/current
      dockerfile: Dockerfile-server

    command: ["python", "app.py"]

    working_dir: /opt/xiaozhi-esp32-server

    environment:
      GOOGLE_APPLICATION_CREDENTIALS: /run/secrets/gcp_sa.json
      GOOGLE_CLOUD_PROJECT: composed-augury-469200-g6
      MQTT_URL: mqtt://mqtt:1883
      OTA_MANIFEST_URL: https://storage.googleapis.com/milu-public/OTA/ota_manifest.json
      PYTHONUNBUFFERED: "1"
      TZ: America/Los_Angeles

    ports:
      - "8000:8000"
      - "8003:8003"

    restart: unless-stopped
    networks:
      default: null

    volumes:
      # 1) Source code (so code changes apply without rebuild)
      - type: bind
        source: /srv/dev/current/main/xiaozhi-server
        target: /opt/xiaozhi-esp32-server
        bind:
          create_host_path: true

      # 2) Runtime config & data
      - type: bind
        source: /srv/dev/current/data
        target: /opt/xiaozhi-esp32-server/data
        bind:
          create_host_path: true

      # 3) GCP Service Account
      - type: bind
        source: /srv/dev/current/data/.gcp/sa.json
        target: /run/secrets/gcp_sa.json
        read_only: true
        bind:
          create_host_path: true

networks:
  default:
    name: current_default
